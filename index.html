<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Town Bakery Project - Student Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Libraries for Word Export -->
    <script src="https://cdn.jsdelivr.net/npm/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bakery: {
                            50: '#fbf8f3',
                            100: '#f5efe4',
                            200: '#eaddc4',
                            300: '#dbc3a0',
                            400: '#c8a176',
                            500: '#b08355',
                            600: '#946643',
                            700: '#79513a',
                            800: '#644335',
                            900: '#52382f',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        textarea::-webkit-scrollbar, .spreadsheet-container::-webkit-scrollbar { width: 8px; height: 8px; }
        textarea::-webkit-scrollbar-track, .spreadsheet-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb, .spreadsheet-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        textarea::-webkit-scrollbar-thumb:hover, .spreadsheet-container::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .upload-area { border: 2px dashed #e5e7eb; transition: all 0.2s; }
        .upload-area:hover { border-color: #b08355; background-color: #fbf8f3; }

        /* Spreadsheet Styles */
        .spreadsheet-container { position: relative; }
        .spreadsheet-table { border-collapse: collapse; background: white; font-size: 0.875rem; table-layout: fixed; width: 0; cursor: default; }
        .spreadsheet-table th, .spreadsheet-table td { border: 1px solid #d1d5db; padding: 4px 8px; position: relative; box-sizing: border-box; overflow: hidden; white-space: nowrap; }
        
        /* Headers */
        .spreadsheet-header { background-color: #f3f4f6; font-weight: bold; text-align: center; color: #4b5563; cursor: pointer; user-select: none; }
        .spreadsheet-header:hover { background-color: #e5e7eb; }
        .row-header { background-color: #f3f4f6; font-weight: bold; text-align: center; color: #4b5563; width: 40px; cursor: pointer; user-select: none; }
        .row-header:hover { background-color: #e5e7eb; }
        
        /* Cell States */
        .spreadsheet-cell { cursor: cell; user-select: none; } 
        
        /* Specific borders for selection range */
        .spreadsheet-cell.selected { background-color: rgba(59, 130, 246, 0.1); }
        .spreadsheet-cell.selected-top { border-top: 2px solid #2563eb; z-index: 5; }
        .spreadsheet-cell.selected-bottom { border-bottom: 2px solid #2563eb; z-index: 5; }
        .spreadsheet-cell.selected-left { border-left: 2px solid #2563eb; z-index: 5; }
        .spreadsheet-cell.selected-right { border-right: 2px solid #2563eb; z-index: 5; }

        .spreadsheet-cell.editing { background-color: white; outline: 2px solid #2563eb; z-index: 20; cursor: text; user-select: text; white-space: normal; overflow: visible; }
        
        /* Moving Feedback */
        .spreadsheet-cell.move-source { opacity: 0.5; background-color: #e5e7eb; }
        .spreadsheet-cell.move-target { background-color: rgba(16, 185, 129, 0.2); border: 2px dashed #10b981; z-index: 6; }

        /* Resizers */
        .col-resizer { position: absolute; top: 0; right: -3px; width: 6px; height: 100%; cursor: col-resize; z-index: 10; }
        .row-resizer { position: absolute; bottom: -3px; left: 0; width: 100%; height: 6px; cursor: row-resize; z-index: 10; }

        /* Context Menu */
        #context-menu { display: none; position: fixed; z-index: 1000; background-color: white; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0.375rem; min-width: 160px; }
        #context-menu button { display: block; width: 100%; text-align: left; padding: 0.5rem 1rem; font-size: 0.875rem; color: #374151; }
        #context-menu button:hover { background-color: #f3f4f6; }
        #context-menu .separator { height: 1px; background-color: #e5e7eb; margin: 4px 0; }
        
        #text-measurer { visibility: hidden; position: absolute; white-space: nowrap; font-size: 0.875rem; font-family: sans-serif; padding: 4px 8px; border: 1px solid transparent; }

        /* Task 4 Wizard Styles */
        .rubric-panel { display: none; animation: slideDown 0.3s ease-out; }
        .rubric-panel.active { display: block; }
        @keyframes slideDown { from { opacity: 0; height: 0; overflow: hidden; transform: translateY(-10px); } to { opacity: 1; height: auto; transform: translateY(0); } }
        
        .checklist-item input[type="checkbox"]:checked + span { text-decoration: line-through; color: #9ca3af; }
        .step-indicator { transition: all 0.3s; }
        .step-indicator.active { background-color: #b08355; color: white; border-color: #b08355; }
        .step-indicator.completed { background-color: #10b981; color: white; border-color: #10b981; }

        /* Details/Summary Animation */
        details.model-answer summary { list-style: none; cursor: pointer; transition: all 0.2s; }
        details.model-answer summary::-webkit-details-marker { display: none; }
        details.model-answer[open] summary { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        details.model-answer[open] .model-content { animation: slideDown 0.2s ease-out; }
    </style>
</head>
<body class="bg-bakery-50 text-gray-800 min-h-screen flex flex-col font-sans" onclick="hideContextMenu()">

    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-bakery-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-bakery-500 text-white p-2 rounded-lg">
                        <i class="fa-solid fa-bread-slice"></i>
                    </div>
                    <h1 class="text-xl font-bold text-bakery-800">Town Bakery Project</h1>
                </div>
                <div class="text-sm text-gray-500 hidden sm:block">Unit 1: Digital Information Point</div>
            </div>
            <!-- Navigation Tabs -->
            <nav class="-mb-px flex space-x-6 overflow-x-auto scrollbar-hide">
                <button onclick="switchTab('context')" id="tab-context" class="tab-btn active border-bakery-500 text-bakery-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Context</button>
                <button onclick="switchTab('proposal')" id="tab-proposal" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Proposal</button>
                <button onclick="switchTab('task')" id="tab-task" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Task 1a</button>
                <button onclick="switchTab('task1b')" id="tab-task1b" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Task 1b</button>
                <button onclick="switchTab('task2')" id="tab-task2" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Task 2 Info</button>
                <button onclick="switchTab('task4')" id="tab-task4" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Task 4: Review</button>
                <button onclick="switchTab('info')" id="tab-info" class="tab-btn border-transparent text-gray-500 hover:text-gray-700 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors">Information</button>
            </nav>
        </div>
    </header>

    <main class="flex-grow max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        <!-- TAB 1: Context -->
        <div id="context" class="tab-content active">
            <div class="bg-white rounded-xl shadow-sm border border-bakery-200 overflow-hidden p-6">
                <h2 class="text-lg font-bold text-bakery-900 mb-4">About the Business</h2>
                <p class="mb-4"><strong>Town Bakery</strong> is a family bakery that sells bread and sweet and savoury items. It needs a digital information point for customers to use.</p>
                <p>The information point will be used to find information about the bakery, the bread and the sweet and savoury items. It will also allow customers to pre-order items.</p>
                <p class="mt-4">It must consist of <strong>four screens</strong> and be accessed using the bakery‚Äôs existing website.</p>
            </div>
        </div>

        <!-- TAB 2: Proposal -->
        <div id="proposal" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-bakery-200 overflow-hidden mb-6">
                <div class="bg-bakery-100 px-6 py-4 border-b border-bakery-200 flex justify-between items-center">
                    <h2 class="text-lg font-bold text-bakery-900">Project Proposal Brief</h2>
                    <span class="bg-bakery-200 text-bakery-800 text-xs font-bold px-2.5 py-0.5 rounded border border-bakery-300">Reference Document</span>
                </div>
                <div class="p-6 md:p-8 space-y-4 text-gray-700">
                    <p>Town Bakery needs a digital information point.</p>
                    <p>The audience for the information point will be adults, teenagers and customers with accessibility needs.</p>
                    <p>Customers can use the information point to find information about the bakery, the items sold and to make any pre-orders.</p>
                    <p>The language used should be clear to all users.</p>
                    <p>Each screen should be consistent, easy to navigate and consider the user‚Äôs accessibility needs.</p>
                    <p class="font-semibold text-bakery-800">The project budget is ¬£6,400 and planned completion is in 14 weeks.</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-bakery-200 overflow-hidden">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-bold text-gray-800">Planning Timescales</h2>
                </div>
                <div class="p-6">
                    <p class="mb-6 italic text-gray-600">It is estimated that the project will take 14 weeks to complete.</p>
                    
                    <div class="space-y-6">
                        <!-- Stage 1 -->
                        <div>
                            <h4 class="font-bold text-bakery-800">Design stage (five weeks total):</h4>
                            <ul class="mt-2 space-y-1 text-sm text-gray-600 list-disc pl-5">
                                <li>research existing user interfaces</li>
                                <li>project proposal</li>
                                <li>produce initial designs</li>
                            </ul>
                        </div>
                        <!-- Stage 2 -->
                        <div>
                            <h4 class="font-bold text-bakery-800">Development stage (six weeks total):</h4>
                            <ul class="mt-2 space-y-1 text-sm text-gray-600 list-disc pl-5">
                                <li>prototyping</li>
                                <li>implementation</li>
                            </ul>
                        </div>
                        <!-- Stage 3 -->
                        <div>
                            <h4 class="font-bold text-bakery-800">Review stage (three weeks total):</h4>
                            <ul class="mt-2 space-y-1 text-sm text-gray-600 list-disc pl-5">
                                <li>user interface</li>
                            </ul>
                        </div>
                    </div>
                    <p class="mt-6 text-sm font-medium text-gray-700">Throughout the project, you will also need to schedule meetings with the client.</p>
                </div>
            </div>
        </div>

        <!-- TAB 3: Task 1a -->
        <div id="task" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg border border-indigo-100 overflow-hidden p-6">
                <h2 class="text-2xl font-bold mb-4">Task 1a: Project Proposal</h2>
                <form class="space-y-6" onsubmit="event.preventDefault();">
                    <div>
                        <label class="block font-bold">1. Purpose and Audience</label>
                        <textarea id="purpose_audience" rows="4" class="w-full border rounded p-2 mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block font-bold">2. Project Requirements</label>
                        <textarea id="reqs" rows="4" class="w-full border rounded p-2 mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block font-bold">3. User Accessibility</label>
                        <textarea id="accessibility" rows="4" class="w-full border rounded p-2 mt-1"></textarea>
                    </div>
                    <div>
                        <label class="block font-bold">4. Constraints</label>
                        <textarea id="constraints" rows="4" class="w-full border rounded p-2 mt-1"></textarea>
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="exportToWord()" class="px-4 py-2 bg-emerald-600 text-white rounded font-bold">Export to .docx</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- TAB 4: Task 1b -->
        <div id="task1b" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg border border-teal-100 overflow-hidden p-6">
                <h2 class="text-2xl font-bold mb-6 text-teal-800">Task 1b: Planning Timescales</h2>
                <div class="space-y-8">
                    <!-- Spreadsheet -->
                    <div>
                        <h3 class="font-bold text-lg mb-2">1. Task List</h3>
                        <div class="bg-gray-50 p-2 mb-2 rounded text-sm border">
                            <i class="fa-solid fa-mouse-pointer mr-1"></i> <strong>Controls:</strong> Double-click to type. Click & drag to select. Drag border of selection to move cells. Right-click for options.
                        </div>
                        <div class="spreadsheet-container w-full overflow-auto border border-gray-300 rounded h-96 relative bg-gray-100">
                            <table id="spreadsheet" class="spreadsheet-table"></table>
                            <div id="text-measurer"></div>
                        </div>
                        <!-- Context Menu -->
                        <div id="context-menu">
                            <button onclick="insertRowBefore()">Insert Row</button>
                            <button onclick="insertColBefore()">Insert Column</button>
                            <div class="separator"></div>
                            <button onclick="deleteRow()" class="text-red-600">Delete Row</button>
                            <button onclick="deleteCol()" class="text-red-600">Delete Column</button>
                        </div>
                    </div>
                    <!-- Gantt -->
                    <div>
                        <h3 class="font-bold text-lg mb-2">2. Gantt Chart</h3>
                        <div class="upload-area p-6 rounded text-center cursor-pointer" onclick="document.getElementById('gantt_upload').click()">
                            <p>Click to upload Gantt Chart Screenshot</p>
                            <input type="file" id="gantt_upload" accept="image/*" class="hidden" onchange="previewImage(this, 'gantt_preview')">
                        </div>
                        <div id="gantt_preview" class="hidden mt-2"><img src="" class="max-h-64 mx-auto border rounded"></div>
                    </div>
                    <!-- PERT -->
                    <div>
                        <h3 class="font-bold text-lg mb-2">3. PERT Chart</h3>
                        <div class="upload-area p-6 rounded text-center cursor-pointer" onclick="document.getElementById('pert_upload').click()">
                            <p>Click to upload PERT Chart Screenshot</p>
                            <input type="file" id="pert_upload" accept="image/*" class="hidden" onchange="previewImage(this, 'pert_preview')">
                        </div>
                        <div id="pert_preview" class="hidden mt-2"><img src="" class="max-h-64 mx-auto border rounded"></div>
                    </div>
                    <div class="flex justify-end">
                        <button onclick="exportToWord()" class="px-4 py-2 bg-emerald-600 text-white rounded font-bold">Export All to .docx</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 5: Task 2 Info -->
        <div id="task2" class="tab-content">
            <div class="bg-white p-6 rounded border">
                <h2 class="font-bold text-lg">Required Screens</h2>
                <ul class="list-disc pl-5 mt-2">
                    <li>1. Home</li>
                    <li>2. Bread</li>
                    <li>3. Sweet and Savoury Items</li>
                    <li>4. Pre-orders</li>
                </ul>
            </div>
        </div>

        <!-- TAB 6: Task 4 Review -->
        <div id="task4" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg border border-purple-200 overflow-hidden">
                <!-- Header & Progress -->
                <div class="bg-purple-50 p-6 border-b border-purple-200">
                    <h2 class="text-2xl font-bold text-purple-900 mb-2">Task 4: Review User Interface</h2>
                    <p class="text-sm text-purple-700 mb-6">Write paragraphs justifying your design choices. Use the checklist to guide your writing.</p>
                    
                    <div class="flex items-center justify-between relative">
                        <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-purple-200 -z-10"></div>
                        <div id="progress-line" class="absolute left-0 top-1/2 transform -translate-y-1/2 h-1 bg-purple-600 -z-10 transition-all duration-300" style="width: 0%;"></div>
                        
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-purple-300 bg-white flex items-center justify-center font-bold text-sm step-indicator" id="ind-0">1</div>
                            <span class="text-xs font-medium mt-1 text-purple-800">Requirements</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-purple-300 bg-white flex items-center justify-center font-bold text-sm step-indicator" id="ind-1">2</div>
                            <span class="text-xs font-medium mt-1 text-purple-800">Suitability</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-purple-300 bg-white flex items-center justify-center font-bold text-sm step-indicator" id="ind-2">3</div>
                            <span class="text-xs font-medium mt-1 text-purple-800">Usability</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-purple-300 bg-white flex items-center justify-center font-bold text-sm step-indicator" id="ind-3">4</div>
                            <span class="text-xs font-medium mt-1 text-purple-800">Design</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-purple-300 bg-white flex items-center justify-center font-bold text-sm step-indicator" id="ind-4"><i class="fa-solid fa-flag"></i></div>
                            <span class="text-xs font-medium mt-1 text-purple-800">Finish</span>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Step Content -->
                <div class="p-6">
                    <div id="t4-writing-area">
                        <h3 id="t4-subheading" class="text-xl font-bold mb-4 text-gray-800"></h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Checklist -->
                            <div class="md:col-span-1 space-y-6">
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <h4 class="font-bold text-sm uppercase tracking-wider text-gray-500 mb-3"><i class="fa-solid fa-list-check mr-2"></i>Checklist</h4>
                                    <div id="t4-checklist" class="space-y-3 text-sm">
                                        <!-- Injected via JS -->
                                    </div>
                                </div>

                                <!-- Model Answer Accordion -->
                                <details class="model-answer bg-amber-50 border border-amber-200 rounded-lg overflow-hidden group">
                                    <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-amber-100 transition-colors">
                                        <span class="font-bold text-amber-800 flex items-center gap-2">
                                            <i class="fa-solid fa-star"></i> View Band 4 Model Answer
                                        </span>
                                        <i class="fa-solid fa-chevron-down text-amber-600 transition-transform group-open:rotate-180"></i>
                                    </summary>
                                    <div class="model-content p-4 text-sm text-gray-700 bg-white border-t border-amber-100 italic leading-relaxed">
                                        <p id="t4-model-text">
                                            <!-- Injected via JS -->
                                        </p>
                                    </div>
                                </details>
                            </div>

                            <!-- Text Area -->
                            <div class="md:col-span-2 flex flex-col">
                                <label class="font-bold text-sm mb-2">Write your paragraph here:</label>
                                <textarea id="t4-textarea" rows="12" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 flex-grow" placeholder="Begin typing your evaluation..."></textarea>
                                
                                <div class="mt-4 flex justify-end">
                                    <button onclick="toggleRubric()" id="btn-self-mark" class="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg font-bold border border-blue-300 transition-colors">
                                        <i class="fa-solid fa-scale-balanced mr-2"></i>Self-Mark Against Rubric
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Rubric Panel (Hidden by default) -->
                        <div id="t4-rubric" class="rubric-panel mt-6 bg-white border-2 border-blue-200 rounded-lg overflow-hidden">
                            <div class="bg-blue-50 px-4 py-3 border-b border-blue-200 flex justify-between items-center">
                                <h4 class="font-bold text-blue-800">Task 4 Rubric Guide</h4>
                                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full font-bold">Important: Rate this specific section independently.</span>
                            </div>
                            
                            <div class="grid grid-cols-2 lg:grid-cols-4 divide-x divide-y lg:divide-y-0 divide-blue-100 text-sm">
                                <!-- Band 1 -->
                                <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="selectBand(1)">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="radio" name="band" id="band1" value="1">
                                        <label for="band1" class="font-bold text-gray-700">Band 1 (1-3 Marks)</label>
                                    </div>
                                    <ul class="list-disc pl-4 space-y-1 text-gray-600 text-xs">
                                        <li>Limited justified review.</li>
                                        <li>Superficial reasoning on requirements & design.</li>
                                        <li>Narrow range of superficial improvements.</li>
                                    </ul>
                                </div>
                                <!-- Band 2 -->
                                <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="selectBand(2)">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="radio" name="band" id="band2" value="2">
                                        <label for="band2" class="font-bold text-gray-700">Band 2 (4-6 Marks)</label>
                                    </div>
                                    <ul class="list-disc pl-4 space-y-1 text-gray-600 text-xs">
                                        <li>Adequate justified review.</li>
                                        <li>Partially developed & generally appropriate reasoning.</li>
                                        <li>Reasonable range of partially appropriate improvements.</li>
                                    </ul>
                                </div>
                                <!-- Band 3 -->
                                <div class="p-4 hover:bg-gray-50 cursor-pointer" onclick="selectBand(3)">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="radio" name="band" id="band3" value="3">
                                        <label for="band3" class="font-bold text-gray-700">Band 3 (7-9 Marks)</label>
                                    </div>
                                    <ul class="list-disc pl-4 space-y-1 text-gray-600 text-xs">
                                        <li>Good justified review.</li>
                                        <li>Mostly developed & largely appropriate reasoning.</li>
                                        <li>Range of mostly appropriate improvements.</li>
                                    </ul>
                                </div>
                                <!-- Band 4 -->
                                <div class="p-4 bg-emerald-50 hover:bg-emerald-100 cursor-pointer border-t-0" onclick="selectBand(4)">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input type="radio" name="band" id="band4" value="4">
                                        <label for="band4" class="font-bold text-emerald-800">Band 4 (10-12 Marks)</label>
                                    </div>
                                    <ul class="list-disc pl-4 space-y-1 text-emerald-700 text-xs font-medium">
                                        <li>Comprehensive justified review.</li>
                                        <li>Well-developed & fully appropriate reasoning.</li>
                                        <li>Wide range of fully appropriate improvements.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Area -->
                    <div id="t4-summary-area" class="hidden">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">
                                <i class="fa-solid fa-check-double text-3xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">Task 4 Complete!</h3>
                            <p class="text-gray-600">Review your full answer below before exporting.</p>
                        </div>
                        
                        <!-- NEW: Score Dashboard -->
                        <div class="bg-white border-2 border-purple-100 rounded-xl p-6 mb-8 shadow-sm">
                            <h4 class="text-lg font-bold text-purple-900 mb-4 flex items-center">
                                <i class="fa-solid fa-chart-line mr-2"></i>Self-Assessment Summary
                            </h4>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Requirements</div>
                                    <div class="font-mono font-bold text-xl text-gray-800" id="score-0">-</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Suitability</div>
                                    <div class="font-mono font-bold text-xl text-gray-800" id="score-1">-</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Usability</div>
                                    <div class="font-mono font-bold text-xl text-gray-800" id="score-2">-</div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 border border-gray-100">
                                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Design</div>
                                    <div class="font-mono font-bold text-xl text-gray-800" id="score-3">-</div>
                                </div>
                                <div class="bg-purple-600 rounded-lg p-3 text-white shadow-lg md:col-span-1 col-span-2">
                                    <div class="text-xs text-purple-200 uppercase font-bold mb-1">Predicted Grade</div>
                                    <div class="font-bold text-xl" id="final-avg-score">Band -</div>
                                </div>
                            </div>
                        </div>

                        <div id="t4-final-review" class="bg-gray-50 border border-gray-200 rounded-lg p-6 space-y-6 mb-6">
                            <!-- Injected via JS -->
                        </div>

                        <div class="flex justify-center">
                            <button onclick="exportTask4ToWord()" class="px-6 py-3 bg-purple-600 text-white hover:bg-purple-700 rounded-lg font-bold text-lg shadow-lg flex items-center transition-all">
                                <i class="fa-solid fa-file-word mr-3"></i>Export Task 4 to .docx
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Footer Navigation -->
                <div class="bg-gray-50 p-4 border-t border-gray-200 flex justify-between rounded-b-xl">
                    <button onclick="prevT4Step()" id="btn-t4-prev" class="px-4 py-2 text-gray-600 hover:text-gray-900 font-bold hidden">
                        <i class="fa-solid fa-arrow-left mr-2"></i>Previous Section
                    </button>
                    <div class="flex-grow"></div>
                    <button onclick="nextT4Step()" id="btn-t4-next" class="px-6 py-2 bg-purple-600 text-white rounded font-bold hover:bg-purple-700 transition-colors">
                        Next Section<i class="fa-solid fa-arrow-right ml-2"></i>
                    </button>
                    <button onclick="goToStep(0)" id="btn-t4-edit" class="px-6 py-2 bg-gray-200 text-gray-800 rounded font-bold hover:bg-gray-300 transition-colors hidden">
                        <i class="fa-solid fa-pen mr-2"></i>Edit Answers
                    </button>
                </div>
            </div>
        </div>

        <!-- TAB 7: Information -->
        <div id="info" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border border-bakery-200 overflow-hidden">
                <div class="bg-bakery-100 px-6 py-4 border-b border-bakery-200">
                    <h2 class="text-lg font-bold text-bakery-900">Information to be used</h2>
                </div>
                <div class="p-6 md:p-8 space-y-6">
                    <p class="mb-4">Select the information that you want to use. Although you do not have to use all the information you must include the pre-order form.</p>
                    
                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                        <h3 class="font-bold text-bakery-800 mb-2">Opening Times</h3>
                        <p class="text-sm text-gray-700 mb-2">Open 6 days a week, excluding Christmas Day and Boxing Day</p>
                        <ul class="list-disc pl-5 text-sm text-gray-700">
                            <li><strong>Monday, Tuesday, Thursday:</strong> 9.30 a.m. until 5.30 p.m.</li>
                            <li><strong>Wednesday:</strong> 9.30 a.m. until 2.30 p.m.</li>
                            <li><strong>Friday, Saturday:</strong> 9.30 a.m. until 6.30 p.m.</li>
                            <li><strong>Sunday:</strong> Closed</li>
                        </ul>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h3 class="font-bold text-blue-800 mb-2">Services & Pricing</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
                            <li>Sweet and savoury items are all home cooked and freshly prepared daily.</li>
                            <li>We cater for customers with special dietary requirements.</li>
                            <li>We can supply a range of party food.</li>
                            <li>10% discount for bulk orders.</li>
                            <li>Our breads use a selection of flours.</li>
                        </ul>
                        <div class="mt-4 pt-2 border-t border-blue-200">
                            <p class="text-sm font-bold text-gray-800 mb-1">Prices range from:</p>
                            <ul class="list-none text-sm text-gray-700">
                                <li>üçû Bread items ¬£1.00 ‚Äì ¬£4.50</li>
                                <li>üç∞ Sweet items ¬£1.00 ‚Äì ¬£6.00</li>
                                <li>ü•ß Savoury items ¬£1.50 ‚Äì ¬£5.50</li>
                            </ul>
                        </div>
                    </div>

                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th colspan="2" class="px-6 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-b border-gray-300">
                                        Pre-order Form
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200 w-1/3">Name</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Telephone</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Email</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Bread items and quantity</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Sweet items and quantity</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Savoury items and quantity</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">Special dietary requirements</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('border-bakery-500', 'text-bakery-700');
                el.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(tabId).classList.add('active');
            const btn = document.getElementById('tab-' + tabId);
            if(btn) {
                btn.classList.remove('border-transparent', 'text-gray-500');
                btn.classList.add('border-bakery-500', 'text-bakery-700');
            }
            
            if(tabId === 'task1b') {
                setTimeout(() => {
                    const table = document.getElementById('spreadsheet');
                    if(table.rows.length === 0) buildSpreadsheetStructure();
                }, 50);
            }
        }

        function previewImage(input, id) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.getElementById(id);
                    div.classList.remove('hidden');
                    div.querySelector('img').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Spreadsheet Core (Updated logic) ---
        let data = Array(20).fill().map(() => Array(7).fill(""));
        let colWidths = Array(7).fill(100);
        let rowHeights = Array(20).fill(32);
        
        let selection = { r1: 0, c1: 0, r2: 0, c2: 0 };
        let state = {
            mode: 'IDLE',
            startX: 0, startY: 0, targetIdx: -1, startSize: 0, 
            moveStartR: -1, moveStartC: -1, canMove: false
        };

        const table = document.getElementById('spreadsheet');

        function buildSpreadsheetStructure() {
            if (!table) return;
            table.innerHTML = '';

            const colGroup = document.createElement('colgroup');
            colGroup.id = 'spreadsheet-cols';
            const corner = document.createElement('col');
            corner.style.width = '40px';
            colGroup.appendChild(corner);
            colWidths.forEach(w => {
                const col = document.createElement('col');
                col.style.width = w + 'px';
                colGroup.appendChild(col);
            });
            table.appendChild(colGroup);

            const thead = document.createElement('tr');
            const thCorner = document.createElement('th');
            thCorner.className = 'spreadsheet-header';
            thCorner.innerText = '‚ó¢';
            thCorner.onclick = () => selectRange(0, 0, data.length - 1, data[0].length - 1);
            thead.appendChild(thCorner);

            for (let c = 0; c < data[0].length; c++) {
                const th = document.createElement('th');
                th.className = 'spreadsheet-header';
                th.innerText = String.fromCharCode(65 + c);
                th.onmousedown = (e) => { if (!e.target.className.includes('resizer')) selectRange(0, c, data.length-1, c); };
                th.ondblclick = () => autoFit(c);
                const resizer = document.createElement('div');
                resizer.className = 'col-resizer';
                resizer.onmousedown = (e) => initResize(e, 'col', c);
                th.appendChild(resizer);
                thead.appendChild(th);
            }
            table.appendChild(thead);

            for (let r = 0; r < data.length; r++) {
                const tr = document.createElement('tr');
                tr.style.height = rowHeights[r] + 'px';

                const th = document.createElement('th');
                th.className = 'row-header';
                th.innerText = r + 1;
                th.onmousedown = (e) => { if (!e.target.className.includes('resizer')) selectRange(r, 0, r, data[0].length-1); };
                const resizer = document.createElement('div');
                resizer.className = 'row-resizer';
                resizer.onmousedown = (e) => initResize(e, 'row', r);
                th.appendChild(resizer);
                tr.appendChild(th);

                for (let c = 0; c < data[0].length; c++) {
                    const td = document.createElement('td');
                    td.className = 'spreadsheet-cell';
                    td.dataset.r = r; td.dataset.c = c;
                    td.innerText = data[r][c];
                    
                    td.onmousedown = (e) => handleCellMouseDown(e, r, c);
                    td.onmouseenter = (e) => handleCellMouseEnter(e, r, c);
                    td.ondblclick = () => startEditing(td, r, c);
                    td.oncontextmenu = (e) => { e.preventDefault(); showContextMenu(e, r, c); };
                    td.onmousemove = (e) => handleCellMouseMove(e, r, c); 
                    tr.appendChild(td);
                }
                table.appendChild(tr);
            }
            updateVisuals(); 
        }

        function updateVisuals() {
            document.querySelectorAll('.spreadsheet-cell').forEach(td => {
                td.className = 'spreadsheet-cell'; 
                if (td.isContentEditable) td.classList.add('editing');
            });

            const minR = Math.min(selection.r1, selection.r2), maxR = Math.max(selection.r1, selection.r2);
            const minC = Math.min(selection.c1, selection.c2), maxC = Math.max(selection.c1, selection.c2);

            for(let r=minR; r<=maxR; r++) {
                if(!table.rows[r+1]) continue;
                for(let c=minC; c<=maxC; c++) {
                    const td = table.rows[r+1].cells[c+1];
                    if(td) {
                        td.classList.add('selected');
                        if(r === minR) td.classList.add('selected-top');
                        if(r === maxR) td.classList.add('selected-bottom');
                        if(c === minC) td.classList.add('selected-left');
                        if(c === maxC) td.classList.add('selected-right');
                        if(state.mode === 'MOVING') td.classList.add('move-source');
                    }
                }
            }
        }

        function handleCellMouseMove(e, r, c) {
            if (state.mode !== 'IDLE' && state.mode !== 'SELECTING') return;
            const minR = Math.min(selection.r1, selection.r2), maxR = Math.max(selection.r1, selection.r2);
            const minC = Math.min(selection.c1, selection.c2), maxC = Math.max(selection.c1, selection.c2);
            state.canMove = false; table.style.cursor = 'default';

            if (r >= minR && r <= maxR && c >= minC && c <= maxC) {
                const rect = e.target.getBoundingClientRect();
                const edge = 5;
                if ((r === minR && e.clientY - rect.top < edge) || (r === maxR && rect.bottom - e.clientY < edge) ||
                    (c === minC && e.clientX - rect.left < edge) || (c === maxC && rect.right - e.clientX < edge)) {
                    table.style.cursor = 'move'; state.canMove = true;
                } else table.style.cursor = 'cell';
            }
        }

        function handleCellMouseDown(e, r, c) {
            if (e.button !== 0 || state.mode === 'EDITING') return;
            if (!e.target.isContentEditable) e.preventDefault(); 
            if (state.canMove) {
                state.mode = 'MOVING'; state.moveStartR = r; state.moveStartC = c; updateVisuals();
            } else {
                state.mode = 'SELECTING'; selection = {r1: r, c1: c, r2: r, c2: c}; updateVisuals();
            }
        }

        function handleCellMouseEnter(e, r, c) {
            if (state.mode === 'SELECTING') {
                selection.r2 = r; selection.c2 = c; updateVisuals();
            } else if (state.mode === 'MOVING') {
                document.querySelectorAll('.move-target').forEach(el => el.classList.remove('move-target'));
                const rDiff = r - state.moveStartR, cDiff = c - state.moveStartC;
                const minR = Math.min(selection.r1, selection.r2) + rDiff, maxR = Math.max(selection.r1, selection.r2) + rDiff;
                const minC = Math.min(selection.c1, selection.c2) + cDiff, maxC = Math.max(selection.c1, selection.c2) + cDiff;
                for(let i=minR; i<=maxR; i++) {
                    if(!table.rows[i+1]) continue;
                    for(let j=minC; j<=maxC; j++) {
                        const cell = table.rows[i+1].cells[j+1];
                        if(cell) cell.classList.add('move-target');
                    }
                }
            }
        }

        window.addEventListener('mouseup', () => {
            if (state.mode === 'RESIZING_COL' || state.mode === 'RESIZING_ROW') {
                state.mode = 'IDLE'; document.body.style.cursor = 'default';
            } else if (state.mode === 'MOVING') finishMove();
            else if (state.mode === 'SELECTING') state.mode = 'IDLE';
        });

        function finishMove() {
            const target = document.querySelector('.move-target');
            state.mode = 'IDLE'; document.querySelectorAll('.move-target').forEach(el => el.classList.remove('move-target'));
            if (!target) { updateVisuals(); return; }
            
            const targetR = parseInt(target.dataset.r), targetC = parseInt(target.dataset.c);
            const minR = Math.min(selection.r1, selection.r2), minC = Math.min(selection.c1, selection.c2);
            const rDiff = targetR - minR, cDiff = targetC - minC;
            if (rDiff === 0 && cDiff === 0) { updateVisuals(); return; }

            const height = Math.abs(selection.r1 - selection.r2) + 1, width = Math.abs(selection.c1 - selection.c2) + 1;
            let temp = [];
            for(let r=0; r<height; r++) {
                temp[r] = [];
                for(let c=0; c<width; c++) { temp[r][c] = data[minR+r][minC+c]; data[minR+r][minC+c] = ""; }
            }
            for(let r=0; r<height; r++) {
                for(let c=0; c<width; c++) {
                    const destR = targetR + r, destC = targetC + c;
                    if (data[destR] && data[destR][destC] !== undefined) data[destR][destC] = temp[r][c];
                }
            }
            selection.r1 += rDiff; selection.r2 += rDiff; selection.c1 += cDiff; selection.c2 += cDiff;
            updateCellContents(); updateVisuals();
        }

        function updateCellContents() {
            for(let r=0; r<data.length; r++) {
                if(!table.rows[r+1]) continue;
                for(let c=0; c<data[0].length; c++) {
                    const td = table.rows[r+1].cells[c+1];
                    if(td && !td.isContentEditable) td.innerText = data[r][c];
                }
            }
        }

        function startEditing(td, r, c) {
            state.mode = 'EDITING'; td.contentEditable = true; td.classList.add('editing'); td.focus();
            td.onblur = () => {
                data[r][c] = td.innerText; td.classList.remove('editing'); td.contentEditable = false;
                state.mode = 'IDLE'; selection = {r1:r, c1:c, r2:r, c2:c}; updateVisuals();
            };
            td.onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); td.blur(); } };
        }

        function initResize(e, type, idx) {
            e.stopPropagation(); e.preventDefault();
            state.mode = type === 'col' ? 'RESIZING_COL' : 'RESIZING_ROW';
            state.targetIdx = idx; state.startX = e.pageX; state.startY = e.pageY;
            state.startSize = type === 'col' ? colWidths[idx] : rowHeights[idx];
            document.body.style.cursor = type === 'col' ? 'col-resize' : 'row-resize';
        }

        window.addEventListener('mousemove', (e) => {
            if (state.mode === 'RESIZING_COL') {
                const w = Math.max(40, state.startSize + (e.pageX - state.startX));
                colWidths[state.targetIdx] = w;
                const colGroup = document.getElementById('spreadsheet-cols');
                if(colGroup) colGroup.children[state.targetIdx+1].style.width = w + 'px';
            } else if (state.mode === 'RESIZING_ROW') {
                const h = Math.max(20, state.startSize + (e.pageY - state.startY));
                rowHeights[state.targetIdx] = h; table.rows[state.targetIdx+1].style.height = h + 'px';
            }
        });

        function autoFit(c) {
            const measurer = document.getElementById('text-measurer'); let max = 60;
            measurer.innerText = String.fromCharCode(65 + c); measurer.style.fontWeight = 'bold'; max = Math.max(max, measurer.offsetWidth + 20);
            data.forEach(row => { measurer.innerText = row[c]; measurer.style.fontWeight = 'normal'; max = Math.max(max, measurer.offsetWidth + 16); });
            colWidths[c] = max; document.getElementById('spreadsheet-cols').children[c+1].style.width = max + 'px';
        }

        function selectRange(r1, c1, r2, c2) { selection = { r1, c1, r2, c2 }; updateVisuals(); }

        function showContextMenu(e, r, c) {
            const menu = document.getElementById('context-menu'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
            const minR = Math.min(selection.r1, selection.r2), maxR = Math.max(selection.r1, selection.r2);
            const minC = Math.min(selection.c1, selection.c2), maxC = Math.max(selection.c1, selection.c2);
            if(r < minR || r > maxR || c < minC || c > maxC) selectRange(r, c, r, c);
        }
        function hideContextMenu() { document.getElementById('context-menu').style.display = 'none'; }

        function insertRowBefore() { const r = Math.min(selection.r1, selection.r2); data.splice(r, 0, Array(data[0].length).fill("")); rowHeights.splice(r, 0, 32); buildSpreadsheetStructure(); }
        function insertColBefore() { const c = Math.min(selection.c1, selection.c2); data.forEach(row => row.splice(c, 0, "")); colWidths.splice(c, 0, 100); buildSpreadsheetStructure(); }
        function deleteRow() { const r = Math.min(selection.r1, selection.r2); if (data.length > 1) { data.splice(r, 1); rowHeights.splice(r, 1); buildSpreadsheetStructure(); } }
        function deleteCol() { const c = Math.min(selection.c1, selection.c2); if (data[0].length > 1) { data.forEach(row => row.splice(c, 1)); colWidths.splice(c, 1); buildSpreadsheetStructure(); } }

        document.addEventListener('keydown', (e) => {
            if (state.mode === 'EDITING' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const minR = Math.min(selection.r1, selection.r2), maxR = Math.max(selection.r1, selection.r2);
                const minC = Math.min(selection.c1, selection.c2), maxC = Math.max(selection.c1, selection.c2);
                for(let r=minR; r<=maxR; r++) for(let c=minC; c<=maxC; c++) data[r][c] = "";
                updateCellContents();
            } else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                const r = Math.min(selection.r1, selection.r2), c = Math.min(selection.c1, selection.c2);
                const td = table.rows[r+1].cells[c+1]; startEditing(td, r, c); td.innerText = e.key; e.preventDefault();
                const range = document.createRange(); range.selectNodeContents(td); range.collapse(false);
                const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
            }
        });

        // --- TASK 4 WIZARD LOGIC ---
        const task4Data = [
            {
                title: "How well have you met the project requirements?",
                checklist: [
                    "Have you met all the user requirements?",
                    "Have you met all the input and output requirements?",
                    "Have you met all the accessibility requirements?"
                ],
                exemplar: "\"There are many requirements that I needed to meet for the user... I have created the four slides that are needed which are home, bread, sweet and savoury and pre-orders. I have also added the logo in the top left corner... because it is the main attraction... it is their brand that people should be able to identify.\""
            },
            {
                title: "How suitable is the user interface for the audience and purpose?",
                checklist: [
                    "Is it suitable for accessibility needs (visual, hearing, speech, motor, cognitive)?",
                    "Is it suitable for the user skills level (expert, regular, occasional, novice)?",
                    "Is it suitable for the user demographics (age, past experiences, beliefs, values, culture)?",
                    "Does the UI allow the user to complete the tasks they need to do?"
                ],
                exemplar: "\"I have added a suitable pale colour for people who have colourblind issues... I have also used a font which is dyslexic friendly... called Century Gothic. I added a magnifying glass so people with vision problems can zoom in... And I have also added a text to speech button for people with hearing issues.\""
            },
            {
                title: "Is the user interface easy to use?",
                checklist: [
                    "Does it match user perceptions (colours, sound, symbols, pictures)?",
                    "Does it sustain the user‚Äôs attention (uncluttered, labels, autofill/tiptext)?",
                    "Is the design intuitive (buttons make sense, helpful pop-ups, help feature)?",
                    "Does it have a consistent design? Can actions be easily reversed?"
                ],
                exemplar: "\"I have made this interface easy to use because I set it out so it is easier to navigate... made sure that they are in the same place on all slides for consistency. I have also added slightly bigger buttons so people with vision problems... are able to access and use the interface.\""
            },
            {
                title: "How effectively have design principles been met?",
                checklist: [
                    "Used appropriate colour choices (limited colours, house colours, good contrast)?",
                    "Used appropriate font sizes/styles (readable, sans-serif font)?",
                    "Used appropriate language (age appropriate, user skill level appropriate)?",
                    "Provided the right amount of information (task completion, white space)?",
                    "Used layout appropriately (consistent, expectations met, prominent items, navigation)?"
                ],
                exemplar: "\"I have used the pale colour in the background... to help with colourblind people. The font size is 16-20 so everyone can read it easily... bold so it stands out. I have thought about the space that is needed to be used as whitespace as this will help the interface not being overcrowded.\""
            }
        ];

        let currentT4Step = 0;
        let t4Answers = ["", "", "", ""];
        let t4Scores = [0, 0, 0, 0]; // 0 = Not set

        function initTask4() {
            // Load saved
            for(let i=0; i<4; i++) {
                const saved = localStorage.getItem(`t4_ans_${i}`);
                if(saved) t4Answers[i] = saved;
                const savedScore = localStorage.getItem(`t4_score_${i}`);
                if(savedScore) t4Scores[i] = parseInt(savedScore);
            }
            renderT4Step();
        }

        function renderT4Step() {
            const writingArea = document.getElementById('t4-writing-area');
            const summaryArea = document.getElementById('t4-summary-area');
            const btnPrev = document.getElementById('btn-t4-prev');
            const btnNext = document.getElementById('btn-t4-next');
            const btnEdit = document.getElementById('btn-t4-edit');

            // Update Progress Bar & Indicators
            const progress = (currentT4Step / 4) * 100;
            document.getElementById('progress-line').style.width = progress + '%';
            
            for(let i=0; i<=4; i++) {
                const ind = document.getElementById(`ind-${i}`);
                ind.classList.remove('active', 'completed', 'border-purple-300');
                if(i < currentT4Step) {
                    ind.classList.add('completed');
                    ind.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else if(i === currentT4Step) {
                    ind.classList.add('active');
                    ind.innerHTML = i === 4 ? '<i class="fa-solid fa-flag"></i>' : (i+1);
                } else {
                    ind.classList.add('border-purple-300');
                    ind.innerHTML = i === 4 ? '<i class="fa-solid fa-flag"></i>' : (i+1);
                }
            }

            if(currentT4Step < 4) {
                // Show writing area
                writingArea.style.display = 'block';
                summaryArea.style.display = 'none';
                btnPrev.style.display = currentT4Step > 0 ? 'inline-block' : 'none';
                btnNext.style.display = 'inline-block';
                btnEdit.style.display = 'none';
                btnNext.innerHTML = 'Next Section<i class="fa-solid fa-arrow-right ml-2"></i>';

                // Populate content
                const data = task4Data[currentT4Step];
                document.getElementById('t4-subheading').innerText = `${currentT4Step + 1}. ${data.title}`;
                
                const clHtml = data.checklist.map((item, idx) => `
                    <label class="flex items-start gap-2 cursor-pointer checklist-item p-1 hover:bg-gray-100 rounded">
                        <input type="checkbox" class="mt-1 w-4 h-4 text-purple-600 rounded focus:ring-purple-500 border-gray-300">
                        <span class="leading-tight">${item}</span>
                    </label>
                `).join('');
                document.getElementById('t4-checklist').innerHTML = clHtml;
                
                // Set exemplar text
                document.getElementById('t4-model-text').innerText = data.exemplar;

                const ta = document.getElementById('t4-textarea');
                ta.value = t4Answers[currentT4Step];
                
                // Restore Score UI
                document.querySelectorAll('input[name="band"]').forEach(el => el.checked = false);
                if(t4Scores[currentT4Step] > 0) {
                    document.getElementById('band' + t4Scores[currentT4Step]).checked = true;
                }
                
                // Hide rubric by default on step switch
                document.getElementById('t4-rubric').classList.remove('active');
                
                // Save on type
                ta.oninput = (e) => {
                    t4Answers[currentT4Step] = e.target.value;
                    localStorage.setItem(`t4_ans_${currentT4Step}`, e.target.value);
                };
            } else {
                // Show summary area
                writingArea.style.display = 'none';
                summaryArea.style.display = 'block';
                btnPrev.style.display = 'none';
                btnNext.style.display = 'none';
                btnEdit.style.display = 'inline-block';

                let summaryHtml = '';
                task4Data.forEach((data, i) => {
                    summaryHtml += `
                        <div class="border-b border-gray-200 pb-4 last:border-0 last:pb-0">
                            <h4 class="font-bold text-lg text-purple-900 mb-2">${i+1}. ${data.title}</h4>
                            <p class="text-gray-700 whitespace-pre-wrap">${t4Answers[i] || '<em class="text-gray-400">No answer provided.</em>'}</p>
                        </div>
                    `;
                });
                document.getElementById('t4-final-review').innerHTML = summaryHtml;
                
                // Calculate Average
                let sum = 0, count = 0;
                t4Scores.forEach((s, i) => {
                    // Update individual score boxes
                    const scoreEl = document.getElementById(`score-${i}`);
                    if(scoreEl) scoreEl.innerText = s > 0 ? `Band ${s}` : '-';
                    
                    if(s > 0) { 
                        sum += s; 
                        count++; 
                    }
                });
                
                const avg = count > 0 ? sum / count : 0;
                let grade = "Not Graded";
                
                if(count > 0) {
                    if(avg < 1.5) grade = "Band 1"; // Rounding logic: 1.0 - 1.49 = 1
                    else if(avg < 2.5) grade = "Band 2"; // 1.5 - 2.49 = 2
                    else if(avg < 3.5) grade = "Band 3"; // 2.5 - 3.49 = 3
                    else grade = "Band 4"; // 3.5+ = 4
                }
                
                const finalEl = document.getElementById('final-avg-score');
                if(finalEl) {
                    finalEl.innerText = grade;
                    if(count < 4 && count > 0) {
                        finalEl.innerHTML += `<span class="block text-xs font-normal opacity-75 mt-1">(Provisional - Complete all sections)</span>`;
                    }
                }
            }
        }

        function toggleRubric() {
            document.getElementById('t4-rubric').classList.toggle('active');
        }

        function selectBand(band) {
            document.getElementById('band' + band).checked = true;
            t4Scores[currentT4Step] = band;
            localStorage.setItem(`t4_score_${currentT4Step}`, band);
        }

        function nextT4Step() {
            if(currentT4Step < 4) {
                currentT4Step++;
                renderT4Step();
            }
        }

        function prevT4Step() {
            if(currentT4Step > 0) {
                currentT4Step--;
                renderT4Step();
            }
        }
        
        function goToStep(step) {
            currentT4Step = step;
            renderT4Step();
        }

        // --- Export (Including Task 4) ---
        async function exportToWord() {
            if (typeof docx === 'undefined') { alert("Loading export library..."); return; }
            const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableRow, TableCell, WidthType, BorderStyle, ImageRun } = docx;
            const createParagraphs = (text) => text.split('\n').map(line => new Paragraph({ children: [new TextRun({ text: line, font: "Calibri" })], spacing: { after: 120 } }));
            
            // Spreadsheet Table
            const taskTable = new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                    new TableRow({ children: data[0].map((_, i) => new TableCell({ children: [new Paragraph({ text: String.fromCharCode(65+i), bold: true })], shading: { fill: "f3f4f6" }, borders: { top: {style: BorderStyle.SINGLE, size: 1}, bottom: {style: BorderStyle.SINGLE, size: 1}, left: {style: BorderStyle.SINGLE, size: 1}, right: {style: BorderStyle.SINGLE, size: 1} } })) }),
                    ...data.map(row => new TableRow({ children: row.map(cellText => new TableCell({ children: [new Paragraph({ text: cellText || "" })], width: { size: 100/row.length, type: WidthType.PERCENTAGE }, borders: { top: {style: BorderStyle.SINGLE, size: 1}, bottom: {style: BorderStyle.SINGLE, size: 1}, left: {style: BorderStyle.SINGLE, size: 1}, right: {style: BorderStyle.SINGLE, size: 1} } })) }))
                ]
            });

            const getImgBuffer = (id) => { const input = document.getElementById(id); return (input.files && input.files[0]) ? new Promise(r => { const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsArrayBuffer(input.files[0]); }) : null; };
            let ganttRun = new Paragraph({ text: "[No Gantt Chart]", italics: true }), pertRun = new Paragraph({ text: "[No PERT Chart]", italics: true });
            try {
                const gBuf = await getImgBuffer('gantt_upload'); if(gBuf) ganttRun = new Paragraph({ children: [new ImageRun({ data: gBuf, transformation: { width: 500, height: 300 } })] });
                const pBuf = await getImgBuffer('pert_upload'); if(pBuf) pertRun = new Paragraph({ children: [new ImageRun({ data: pBuf, transformation: { width: 500, height: 300 } })] });
            } catch(e) {}

            const doc = new Document({
                creator: "Student",
                sections: [{
                    children: [
                        new Paragraph({ text: "Town Bakery Project", heading: HeadingLevel.TITLE, alignment: docx.AlignmentType.CENTER }),
                        new Paragraph({ text: "Task 1a", heading: HeadingLevel.HEADING_1 }),
                        new Paragraph({ text: "Purpose", heading: HeadingLevel.HEADING_2 }), ...createParagraphs(document.getElementById('purpose_audience').value),
                        new Paragraph({ text: "Requirements", heading: HeadingLevel.HEADING_2 }), ...createParagraphs(document.getElementById('reqs').value),
                        new Paragraph({ text: "Accessibility", heading: HeadingLevel.HEADING_2 }), ...createParagraphs(document.getElementById('accessibility').value),
                        new Paragraph({ text: "Constraints", heading: HeadingLevel.HEADING_2 }), ...createParagraphs(document.getElementById('constraints').value),
                        new Paragraph({ text: "Task 1b", heading: HeadingLevel.HEADING_1, pageBreakBefore: true }),
                        new Paragraph({ text: "Task List", heading: HeadingLevel.HEADING_2 }), taskTable,
                        new Paragraph({ text: "Gantt Chart", heading: HeadingLevel.HEADING_2 }), ganttRun,
                        new Paragraph({ text: "PERT Chart", heading: HeadingLevel.HEADING_2 }), pertRun
                    ]
                }]
            });
            Packer.toBlob(doc).then(blob => saveAs(blob, "Town_Bakery_Task1.docx"));
        }

        async function exportTask4ToWord() {
            if (typeof docx === 'undefined') { alert("Loading export library..."); return; }
            const { Document, Packer, Paragraph, TextRun, HeadingLevel } = docx;
            const createParagraphs = (text) => text ? text.split('\n').map(line => new Paragraph({ children: [new TextRun({ text: line, font: "Calibri" })], spacing: { after: 120 } })) : [new Paragraph({ text: "No answer provided.", italics: true })];
            
            const children = [
                new Paragraph({ text: "Task 4: Review User Interface", heading: HeadingLevel.TITLE, alignment: docx.AlignmentType.CENTER }),
            ];

            task4Data.forEach((data, i) => {
                children.push(new Paragraph({ text: data.title, heading: HeadingLevel.HEADING_2, spacing: { before: 240 } }));
                children.push(...createParagraphs(t4Answers[i]));
            });

            const doc = new Document({ creator: "Student", sections: [{ children }] });
            Packer.toBlob(doc).then(blob => saveAs(blob, "Town_Bakery_Task4_Review.docx"));
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            buildSpreadsheetStructure();
            document.querySelectorAll('textarea:not(#t4-textarea)').forEach(input => {
                const saved = localStorage.getItem('town_bakery_' + input.id);
                if (saved) input.value = saved;
                input.addEventListener('input', (e) => localStorage.setItem('town_bakery_' + e.target.id, e.target.value));
            });
            initTask4();
        });
    </script>
</body>
</html>
